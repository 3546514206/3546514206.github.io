<!DOCTYPE html>


<html lang="zh-CN">


<head>
    <meta charset="utf-8"/>
    
    
    
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>
        Kubernetes中原生的Sidecar容器 |
        
        </title>
  <meta name="generator" content="hexo-theme-ayer">
    
        <link rel="shortcut icon" href="/images/SETSUNAYANG.JPG"/>
    
    
<link rel="stylesheet" href="/dist/main.css">

    
<link rel="stylesheet" href="/css/fonts/remixicon.css">

    
<link rel="stylesheet" href="/css/custom.css">

    
        <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
    
    
 

    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

    <!-- mermaid -->
    
    <style>
        .swal2-styled.swal2-confirm {
            font-size: 1.6rem;
        }
    </style>
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head>
</html>
</html>


<body>
<div id="app">
    
    
    <main class="content on">
        <section class="outer">
    <article
        id="post-Kubernetes中原生的Sidecar容器"
        class="article article-type-post"
        itemscope
        itemprop="blogPost"
        data-scroll-reveal
>
    <div class="article-inner">
        
            <header class="article-header">
                 
    <h1 class="article-title sea-center" style="border-left:0" itemprop="name">
        Kubernetes中原生的Sidecar容器
    </h1>
 

                
            </header>
        
        
            <div class="article-meta">
                <a href="/2024/07/18/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/" class="article-date">
    <time datetime="2024-07-18T07:10:17.000Z" itemprop="datePublished">2024-07-18</time>
</a> 
                 
    <div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">9.6k</span>
        </span>
    </span>

        <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">43 分钟</span>
        </span>
    </span>
    </div>

                
            </div>
        
         
    <div class="tocbot"></div>





        
        
            <div class="article-entry" itemprop="articleBody">
                 

                 <h4 id="1-sidecar容器的概念"><strong>1、Sidecar容器的概念</strong></h4>
<p>     sidecar 容器的概念在 Kubernetes 早期就已经存在。多年来，sidecar 模式在应用程序中变得越来越普遍，使用场景也变得更加多样化。其中比较经典的就是 Istio 通过 sidecar 容器实现了服务网格的功能，Envoy 作为 sidecar 容器与应用程序容器一起运行，负责处理所有的网络流量，实现了服务之间的安全通信、流量管理、监控等功能。</p>
<p><img src="/pic/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/sidecar.webp" alt="sidecar"></p>
<h4 id="2-当前sidecar容器的问题"><strong>2、当前Sidecar容器的问题</strong></h4>
<p>     当前的 Kubernetes 原语可以很好地处理这种模式，但是对于几个用例来说，它们还存在着不足，并且迫使应用程序采用奇怪的变通方法。</p>
<h4 id="2-1-问题-1：使用-sidecar-容器的-job"><strong>2.1、问题 1：使用 Sidecar 容器的 Job</strong></h4>
<p>     假设你有一个 Job，其中包含两个容器：一个是用于执行作业的主容器，另一个只是完成辅助任务的 sidecar 容器。这个辅助容器可以是用于服务网格、收集指标或者日志的服务等等。当 Job 中的主容器完成任务退出时，由于 sidecar 容器还在运行，最终会导致 Pod 无法正常终止。此外，对于 restartPolicy:Never 的 Job，当 sidecar 容器因为 OOM 被杀死时，它不会被重新启动，如果 sidecar 容器为其他容器提供网络或者安全通信，这可能会导致 Pod 无法使用。</p>
<p>     下面我们可以通过一个简单的例子来演示这个问题。下面是一个 Job 的 YAML 文件，其中包含两个容器：一个是主容器 main-container-1，另一个是 sidecar 容器 sidecar-container-1。main-container-1 容器在完成一些任务后会正常退出，而 sidecar-container-1 容器会则一直运行。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container-1</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">              echo &quot;main container is starting...&quot;</span></span><br><span class="line"><span class="string">              for i in $(seq 1 5); do</span></span><br><span class="line"><span class="string">                echo &quot;main container is doing some task: $i/5&quot;</span></span><br><span class="line"><span class="string">                sleep 3</span></span><br><span class="line"><span class="string">              done</span></span><br><span class="line"><span class="string">              echo &quot;main container completed tasks and exited&quot;</span></span><br><span class="line"><span class="string"></span>        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sidecar-container-1</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">              echo &quot;sidecar container is starting...&quot;</span></span><br><span class="line"><span class="string">              while true; do</span></span><br><span class="line"><span class="string">                echo &quot;sidecar container is collecting logs...&quot;</span></span><br><span class="line"><span class="string">                sleep 1</span></span><br><span class="line"><span class="string">              done</span></span><br><span class="line"><span class="string"></span>      <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br></pre></td></tr></table></figure>
<p>     执行以下命令应用上面的 Job 资源。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f 1-job-cannot-complete.yaml</span><br></pre></td></tr></table></figure>
<p>     在本文的实验中，我们会在一个 Pod 中同时运行多个容器，为了方便观察日志，我们可以使用 stern 这个开源工具。 stern 允许我们同时查看多个 Pod 中多个容器的日志，并且以不同颜色进行显示，方便我们直观地进行区分。</p>
<p>     执行以下命令查看 myapp Pod 中所有容器的日志：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --diff-container 参数会为每个容器的日志添加不同的颜色，默认情况下，只会为每个 Pod 的日志添加不同的颜色</span></span><br><span class="line">stern myapp --diff-container</span><br></pre></td></tr></table></figure>
<p>     从日志中可以看到，main-container-1 容器完成任务后正常退出，而 sidecar-container-1 还在持续运行，最终导致这个 Job 无法正常结束。</p>
<p><img src="/pic/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/Pod%E6%97%A5%E5%BF%97.webp" alt="Pod日志"></p>
<p>     如果我们提前在另一个窗口执行 kubectl get pod -w 命令，可以观察到 Pod 的状态变化如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-fdpb7   0/2     Pending   0          0s</span><br><span class="line">myapp-fdpb7   0/2     Pending   0          0s</span><br><span class="line">myapp-fdpb7   0/2     ContainerCreating   0          0s</span><br><span class="line">myapp-fdpb7   2/2     Running             0          2s</span><br><span class="line">myapp-fdpb7   1/2     NotReady            0          17s</span><br></pre></td></tr></table></figure>
<p>     每行状态的解释如下，完整的 Pod 资源内容请查看 logs/1-job-cannot-complete-status.yaml 文件：</p>
<p>     1.Pod 创建后还未被调度，Pod 的 Phase 为 Pending。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Pending</span></span><br><span class="line">  <span class="attr">qosClass:</span> <span class="string">BestEffort</span></span><br></pre></td></tr></table></figure>
<p>     2.Pod 已经被调度到 Node 上，但是容器还未被创建，Pod 的 Phase 还是 Pending。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2024-05-28T13:05:25Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">PodScheduled</span> <span class="comment"># Pod 已经被调度到 Node 上</span></span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Pending</span></span><br><span class="line">  <span class="attr">qosClass:</span> <span class="string">BestEffort</span></span><br></pre></td></tr></table></figure>
<p>     3.正在等待创建容器，Pod 还没有处于 Ready 状态，Pod 的 Phase 仍为 Pending。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2024-05-28T13:05:25Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Initialized</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2024-05-28T13:05:25Z&quot;</span></span><br><span class="line">      <span class="attr">message:</span> <span class="string">&#x27;containers with unready status: [main-container-1 sidecar-container-1]&#x27;</span></span><br><span class="line">      <span class="attr">reason:</span> <span class="string">ContainersNotReady</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;False&quot;</span> <span class="comment"># Pod 还没有处于 Ready 状态</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2024-05-28T13:05:25Z&quot;</span></span><br><span class="line">      <span class="attr">message:</span> <span class="string">&#x27;containers with unready status: [main-container-1 sidecar-container-1]&#x27;</span></span><br><span class="line">      <span class="attr">reason:</span> <span class="string">ContainersNotReady</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">ContainersReady</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2024-05-28T13:05:25Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">PodScheduled</span></span><br><span class="line">  <span class="attr">containerStatuses:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">lastState:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">name:</span> <span class="string">main-container-1</span></span><br><span class="line">      <span class="attr">ready:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">restartCount:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">started:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">state:</span></span><br><span class="line">        <span class="attr">waiting:</span> <span class="comment"># 等待容器创建完成</span></span><br><span class="line">          <span class="attr">reason:</span> <span class="string">ContainerCreating</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">lastState:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">name:</span> <span class="string">sidecar-container-1</span></span><br><span class="line">      <span class="attr">ready:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">restartCount:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">started:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">state:</span></span><br><span class="line">        <span class="attr">waiting:</span> <span class="comment"># 等待容器创建完成</span></span><br><span class="line">          <span class="attr">reason:</span> <span class="string">ContainerCreating</span></span><br><span class="line">  <span class="attr">hostIP:</span> <span class="number">172.19</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Pending</span></span><br><span class="line">  <span class="attr">qosClass:</span> <span class="string">BestEffort</span></span><br><span class="line">  <span class="attr">startTime:</span> <span class="string">&quot;2024-05-28T13:05:25Z&quot;</span></span><br></pre></td></tr></table></figure>
<p>     4.所有容器在运行中，Pod 的 Phase 变为 Running。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2024-05-28T13:05:25Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Initialized</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2024-05-28T13:05:27Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2024-05-28T13:05:27Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">ContainersReady</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2024-05-28T13:05:25Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">PodScheduled</span></span><br><span class="line">  <span class="attr">containerStatuses:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">containerd://af182325a9bb106697dc56f7ff25e96d6dd22d45eb134990d9c4820349c11232</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">docker.io/library/busybox:1.35</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker.io/library/busybox@sha256:469d6089bc898ead80a47dab258a127ffdae15342eab860be3be9ed2acdee33b</span></span><br><span class="line">      <span class="attr">lastState:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">name:</span> <span class="string">main-container-1</span></span><br><span class="line">      <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">restartCount:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">started:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">state:</span></span><br><span class="line">        <span class="attr">running:</span> <span class="comment"># 主容器在运行中</span></span><br><span class="line">          <span class="attr">startedAt:</span> <span class="string">&quot;2024-05-28T13:05:26Z&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">containerd://fb24805ffe5ee1fddb64a728ee8853299f9c093b2722b77d54808d9821b90b0e</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">docker.io/library/busybox:1.35</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker.io/library/busybox@sha256:469d6089bc898ead80a47dab258a127ffdae15342eab860be3be9ed2acdee33b</span></span><br><span class="line">      <span class="attr">lastState:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">name:</span> <span class="string">sidecar-container-1</span></span><br><span class="line">      <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">restartCount:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">started:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">state:</span></span><br><span class="line">        <span class="attr">running:</span> <span class="comment"># sidecar 容器在运行中</span></span><br><span class="line">          <span class="attr">startedAt:</span> <span class="string">&quot;2024-05-28T13:05:26Z&quot;</span></span><br><span class="line">  <span class="attr">hostIP:</span> <span class="number">172.19</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Running</span></span><br><span class="line">  <span class="attr">podIP:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.7</span></span><br><span class="line">  <span class="attr">podIPs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.7</span></span><br><span class="line">  <span class="attr">qosClass:</span> <span class="string">BestEffort</span></span><br><span class="line">  <span class="attr">startTime:</span> <span class="string">&quot;2024-05-28T13:05:25Z&quot;</span></span><br></pre></td></tr></table></figure>
<p>     5.main-container-1 容器完成任务后正常退出，而 sidecar-container-1 还在持续运行，最终这个 Job 无法正常结束。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2024-05-28T13:05:25Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Initialized</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2024-05-28T13:05:42Z&quot;</span></span><br><span class="line">      <span class="attr">message:</span> <span class="string">&#x27;containers with unready status: [main-container-1]&#x27;</span></span><br><span class="line">      <span class="attr">reason:</span> <span class="string">ContainersNotReady</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2024-05-28T13:05:42Z&quot;</span></span><br><span class="line">      <span class="attr">message:</span> <span class="string">&#x27;containers with unready status: [main-container-1]&#x27;</span></span><br><span class="line">      <span class="attr">reason:</span> <span class="string">ContainersNotReady</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">ContainersReady</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2024-05-28T13:05:25Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">PodScheduled</span></span><br><span class="line">  <span class="attr">containerStatuses:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">containerd://af182325a9bb106697dc56f7ff25e96d6dd22d45eb134990d9c4820349c11232</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">docker.io/library/busybox:1.35</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker.io/library/busybox@sha256:469d6089bc898ead80a47dab258a127ffdae15342eab860be3be9ed2acdee33b</span></span><br><span class="line">      <span class="attr">lastState:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">name:</span> <span class="string">main-container-1</span></span><br><span class="line">      <span class="attr">ready:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">restartCount:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">started:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">state:</span></span><br><span class="line">        <span class="attr">terminated:</span> <span class="comment"># 主容器已经正常退出</span></span><br><span class="line">          <span class="attr">containerID:</span> <span class="string">containerd://af182325a9bb106697dc56f7ff25e96d6dd22d45eb134990d9c4820349c11232</span></span><br><span class="line">          <span class="attr">exitCode:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">finishedAt:</span> <span class="string">&quot;2024-05-28T13:05:41Z&quot;</span></span><br><span class="line">          <span class="attr">reason:</span> <span class="string">Completed</span></span><br><span class="line">          <span class="attr">startedAt:</span> <span class="string">&quot;2024-05-28T13:05:26Z&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">containerd://fb24805ffe5ee1fddb64a728ee8853299f9c093b2722b77d54808d9821b90b0e</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">docker.io/library/busybox:1.35</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker.io/library/busybox@sha256:469d6089bc898ead80a47dab258a127ffdae15342eab860be3be9ed2acdee33b</span></span><br><span class="line">      <span class="attr">lastState:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">name:</span> <span class="string">sidecar-container-1</span></span><br><span class="line">      <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">restartCount:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">started:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">state:</span></span><br><span class="line">        <span class="attr">running:</span> <span class="comment"># sidecar 容器还在继续运行</span></span><br><span class="line">          <span class="attr">startedAt:</span> <span class="string">&quot;2024-05-28T13:05:26Z&quot;</span></span><br><span class="line">  <span class="attr">hostIP:</span> <span class="number">172.19</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Running</span></span><br><span class="line">  <span class="attr">podIP:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.7</span></span><br><span class="line">  <span class="attr">podIPs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.7</span></span><br><span class="line">  <span class="attr">qosClass:</span> <span class="string">BestEffort</span></span><br><span class="line">  <span class="attr">startTime:</span> <span class="string">&quot;2024-05-28T13:05:25Z&quot;</span></span><br></pre></td></tr></table></figure>
<p>     下面这张图展示了上面描述的 Pod 状态变化过程：</p>
<p><img src="/pic/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/Pod%E7%8A%B6%E6%80%81%E5%8F%98%E5%8C%96%E8%BF%87%E7%A8%8B.webp" alt="Pod状态变化过程"></p>
<p>     这里有几个地方需要解释一下，在我们观察容器和 Pod 的状态时，Kubernetes 提供了一些字段来帮助我们理解 Pod 的状态：</p>
<p>     <strong>Pod phase:</strong> Pod phase 是对 Pod 在其生命周期中所处位置的一个高层次的概括，包括 Pending、Running、Succeeded、Failed 和 Unknown。</p>
<ul>
<li>
<p>Pending：Pod 已被 Kubernetes 系统接受，但有一个或者多个容器尚未被创建。此阶段包括等待 Pod 被调度的时间和通过网络下载镜像的时间。</p>
</li>
<li>
<p>Running：Pod 中的所有容器都已经被创建，并且至少有一个容器正在运行，或者正在启动或者重启。</p>
</li>
<li>
<p>Succeeded：Pod 中的所有容器都已经成功终止，并且不会再重启。</p>
</li>
<li>
<p>Failed：Pod 中的所有容器都已经终止，但至少有一个容器是因为失败而终止。</p>
</li>
<li>
<p>Unknown：Pod 的状态无法被获取，通常是由于与 Pod 应该运行的节点通信失败导致的。</p>
</li>
</ul>
<p>     <strong>Container states:</strong> 容器的状态，包括 Waiting、Running 和 Terminated。我在上图右边部分的方框中用不同的颜色标记了这三种 Container states，另外在括号内部还对相同 Container states 的不同情况作了区分。</p>
<ul>
<li>
<p>Waiting：容器正在等待某些条件满足，例如正在拉取镜像，或者应用 Secret 数据。</p>
</li>
<li>
<p>Running：容器正在运行中。</p>
</li>
<li>
<p>Terminated：容器已经终止，可能是正常结束或者因为某些原因失败。如果你使用 kubectl describe pod 或者 kubectl get pod 命令来查询包含 Terminated 状态的容器的 Pod 时， 你会看到容器进入此状态的原因、退出代码以及容器执行期间的起止时间。</p>
</li>
</ul>
<p>     <strong>Pod Status：</strong> 在执行 kubectl get pod 命令时返回的 Pod 状态，该字段是 Pod 内所有容器状态的一个聚合，具体的源代码参见 printPod 函数.有以下几个常见的状态：</p>
<ul>
<li>
<p>Init:N/M：Pod 包含 M 个 init 容器，其中 N 个已经运行完成。</p>
</li>
<li>
<p>Init:Error：Pod 中的某个 init 容器执行失败。</p>
</li>
<li>
<p>Init:CrashLoopBackOff：Pod 中的某个 init 容器多次失败。</p>
</li>
<li>
<p>Pending：Pod 尚未开始创建 init 容器。</p>
</li>
<li>
<p>PodInitializing：Pod 已经执行完所有 init 容器，在等待创建主容器。</p>
</li>
<li>
<p>ContainerCreating：当 Pod 中不包含 init 容器时，在等待创建主容器时会显示这个状态。</p>
</li>
<li>
<p>Running：Pod 中的所有容器都在运行中。</p>
</li>
</ul>
<p>     <strong>Pod Ready：</strong> 以 Ready 的容器数量 / 所有容器的数量的形式展示。</p>
<p>     测试完毕后，执行以下命令删除这个 Job。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f 1-job-cannot-complete.yaml</span><br></pre></td></tr></table></figure>
<h4 id="2-2-问题-2：日志转发和指标收集的-sidecar-容器"><strong>2.2、问题 2：日志转发和指标收集的 Sidecar 容器</strong></h4>
<p>     日志转发和指标收集的 sidecar 容器应该在主应用容器之前启动，以便能够完整地收集日志和指标。如果 sidecar 容器在主应用容器之后启动，而主应用容器在启动时崩溃，则可能会导致日志丢失（取决于日志是否通过共享卷或者通过 Localhost 网络来进行收集）。 另外，在 Pod 停止时，如果 sidecar 容器先于其他容器退出，也会导致日志丢失的问题。</p>
<h4 id="2-3-问题-3：服务网格"><strong>2.3、问题 3：服务网格</strong></h4>
<p>     服务网格的 sidecar 容器需要在其他容器之前运行并准备就绪，以确保流量能够正确地通过服务网格。在关闭时，如果服务网格容器先于其他容器终止，也可能会导致流量异常。</p>
<h4 id="2-4-问题-4：配置-密钥"><strong>2.4、问题 4：配置/密钥</strong></h4>
<p>     当前，一些 Pod 使用 init 容器来获取配置/密钥，然后使用 sidecar 容器来持续监视变更并将更新推送给主容器，这需要两个独立的容器来实现。也许可以考虑使用同一个 sidecar 容器来处理这两种情况，以简化实现。</p>
<h4 id="3-什么是原生-sidecar-容器"><strong>3、什么是原生 Sidecar 容器</strong></h4>
<p>     Kubernetes 1.28 引入了一种新型容器 - sidecar 容器。Kubernetes 将 sidecar 容器作为 init 容器的一个特例来实现，在 Pod 启动后，sidecar 容器仍将保持运行状态。</p>
<p>     具体的实现方式是在 init 容器中添加了一个新的 restartPolicy 字段， 该字段在 SidecarContainers 特性门控启用时可用（该特性自 Kubernetes v1.29 起默认启用）。该字段是可选的，如果对其设置，则唯一有效的值为 Always。设置了这个字段以后，init 容器就成为了 sidecar 容器，它们会在 Pod 的整个生命周期内持续运行，而不是像 init 容器那样在成功执行完任务后就退出。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-fetch</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">secret-fetch:1.0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">network-proxy</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">network-proxy:1.0</span></span><br><span class="line">    <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>     接下来让我们通过一些实验来深入理解 sidecar 容器的特性。</p>
<h4 id="4-环境准备"><strong>4、环境准备</strong></h4>
<p>     在本文中，我们将使用 Kind 来创建一个 Kubernetes 集群。Kind 是一个用于在 Docker 容器中运行本地 Kubernetes 集群的工具，它使用 Docker 容器作为节点，并在这些节点上运行 Kubernetes 的相关组件。</p>
<p>     在 Kind 配置文件中启用 SidecarContainers 特性门控，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Cluster</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kind.x-k8s.io/v1alpha4</span></span><br><span class="line"><span class="attr">featureGates:</span></span><br><span class="line">  <span class="attr">SidecarContainers:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>     然后执行以下命令创建一个 Kubernetes 集群，集群的版本为 v1.28.0。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kind create cluster --name=sidecar-demo-cluster \</span><br><span class="line">--image kindest/node:v1.28.0 \</span><br><span class="line">--config sidecar-feature-enable.yaml</span><br></pre></td></tr></table></figure>
<h4 id="5-init-容器和主容器"><strong>5、Init 容器和主容器</strong></h4>
<p>     首先我们先来观察一下只有 init 容器和普通主容器的情况。在下面的示例中，我们定义了 3 个 init 容器和 2 个主容器。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">          sleep 10</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 completed tasks and exited&quot;</span></span><br><span class="line"><span class="string"></span>    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-container-2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;init container 2 is starting...&quot;</span></span><br><span class="line"><span class="string">          echo &quot;init container 2 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">          sleep 10</span></span><br><span class="line"><span class="string">          echo &quot;init container 2 completed tasks and exited&quot;</span></span><br><span class="line"><span class="string"></span>    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-container-3</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;init container 3 is starting...&quot;</span></span><br><span class="line"><span class="string">          echo &quot;init container 3 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">          sleep 10</span></span><br><span class="line"><span class="string">          echo &quot;init container 3 completed task and exited&quot;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;main container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;main container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container-2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span> ]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;main container 2 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;main container 2 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br></pre></td></tr></table></figure>
<p>     执行以下命令应用上面的 Pod 资源。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f 2-init-and-main-containers.yaml</span><br></pre></td></tr></table></figure>
<p>     执行 stern 命令查看 Pod 的日志，可以看到 3 个 init 容器是按照定义的顺序依次启动的。每个 init 容器在执行完任务后都会正常退出，而下一个 init 容器则会等到前一个 init 容器退出后才会开始启动。</p>
<p>     等到所有的 init 容器退出后，两个主容器才会开始启动，它们之间的启动并没有先后顺序。</p>
<p><img src="/pic/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/Pod%E6%97%A5%E5%BF%972.webp" alt="Pod日志2"></p>
<p>     如果我们提前在另一个窗口执行 kubectl get pod -w 命令，可以观察到 Pod 的状态变化。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp   0/2     Pending   0          0s</span><br><span class="line">myapp   0/2     Pending   0          0s</span><br><span class="line">myapp   0/2     Init:0/3   0          0s</span><br><span class="line">myapp   0/2     Init:0/3   0          1s</span><br><span class="line">myapp   0/2     Init:1/3   0          12s</span><br><span class="line">myapp   0/2     Init:1/3   0          13s</span><br><span class="line">myapp   0/2     Init:2/3   0          23s</span><br><span class="line">myapp   0/2     Init:2/3   0          24s</span><br><span class="line">myapp   0/2     PodInitializing   0          34s</span><br><span class="line">myapp   2/2     Running           0          35s</span><br></pre></td></tr></table></figure>
<p>     每行状态的解释如下，完整的 Pod 资源内容请查看 logs/2-init-and-main-containers-status.yaml 文件：</p>
<p>     1.Pod 创建后还未被调度。</p>
<p>     2.Pod 已经被调度到 Node 上，但是容器还未被创建。</p>
<p>     3.等待创建第 1 个 init 容器。</p>
<p>     4.第 1 个 init 容器正在运行。</p>
<p>     5.第 1 个 init 容器正常退出，等待创建第 2 个 init 容器。</p>
<p>     6.第 2 个 init 容器正在运行。</p>
<p>     7.第 2 个 init 容器正常退出，等待创建第 3 个 init 容器。</p>
<p>     8.第 3 个 init 容器正在运行。</p>
<p>     9.所有的 init 容器都已经正常退出，等待创建 main-container-1 和 main-container-2 两个主容器。</p>
<p>     10.两个主容器都正在运行。</p>
<p>     下面这张图展示了上面描述的 Pod 状态变化过程：</p>
<p><img src="/pic/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/Pod%E7%8A%B6%E6%80%81%E5%8F%98%E5%8C%96%E8%BF%87%E7%A8%8B2.webp" alt="Pod状态变化过程2"></p>
<p>     测试完毕后，执行以下命令删除这个 Pod。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行 --force 参数立即删除 Pod，方便我们快速进行实验</span></span><br><span class="line"><span class="comment"># 不等待 terminationGracePeriodSeconds（默认是 30s）时间就让 Kubelet 强制发送 SIGKILL 信号，因为我们当前的容器并不会处理 SIGTERM 信号，这将在第 9 小节中会进一步说明</span></span><br><span class="line"><span class="comment"># 如果这里不使用 --force 参数，容器将等待 30s 后容器才会退出， </span></span><br><span class="line">kubectl delete -f 2-init-and-main-containers.yaml --force</span><br></pre></td></tr></table></figure>
<h4 id="6-init-容器-sidecar-容器和主容器"><strong>6、Init 容器、Sidecar 容器和主容器</strong></h4>
<p>     接下来，我们在 Pod 中引入 sidecar 容器，sidecar 容器是设置了 restartPolicy: Always 的 init 容器。在下面的示例中，我们定义了 3 个 init 容器、2 个 sidecar 容器和 2 个主容器。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">          sleep 10</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 completed tasks and exited&quot;</span></span><br><span class="line"><span class="string"></span>    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sidecar-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;sidecar container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;sidecar container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>      <span class="attr">restartPolicy:</span> <span class="string">Always</span> <span class="comment"># sidecar 容器是设置了 restartPolicy: Always 的 init 容器</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sidecar-container-2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;sidecar container 2 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;sidecar container 2 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;main container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;main container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container-2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span> ]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;main container 2 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;main container 2 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br></pre></td></tr></table></figure>
<p>     执行以下命令应用上面的 Pod 资源。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f 3-init-and-sidecar-and-main-containers.yaml</span><br></pre></td></tr></table></figure>
<p>     从日志中我们可以清晰地看到整个 Pod 的启动过程。首先，init-container-1 作为第一个 init 容器启动，在成功执行完任务后正常退出。</p>
<p>     接下来，sidecar-container-1 作为第一个 sidecar 容器开始启动，接着是 sidecar-container-2 容器 。与 init 容器类似，sidecar 容器也是按照定义的顺序逐个启动的。不同的是，sidecar 不会像 init 容器那样在完成任务后退出。这确保了 sidecar 容器可以在 Pod 的整个生命周期内提供辅助功能。</p>
<p>     当两个 sidecar 容器启动并成功运行后，两个主容器才会开始启动。两个主容器之间并没有固定的启动顺序，它们几乎是同时启动的。</p>
<p>     最后我们可以看到 sidecar 容器和主容器会一直运行，交替输出日志。</p>
<p><img src="/pic/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/Pod%E6%97%A5%E5%BF%973.webp" alt="Pod日志3"></p>
<p>     如果我们提前在另一个窗口执行 kubectl get pod -w 命令，可以观察到 Pod 的状态变化。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp   0/4     Pending   0          0s</span><br><span class="line">myapp   0/4     Pending   0          0s</span><br><span class="line">myapp   0/4     Init:0/3   0          0s</span><br><span class="line">myapp   0/4     Init:0/3   0          1s</span><br><span class="line">myapp   0/4     Init:1/3   0          11s</span><br><span class="line">myapp   1/4     Init:2/3   0          12s</span><br><span class="line">myapp   2/4     PodInitializing   0          13s</span><br><span class="line">myapp   4/4     Running           0          14s</span><br></pre></td></tr></table></figure>
<p>     每行状态的解释如下，完整的 Pod 资源内容请查看 logs/3-init-and-sidecar-and-main-containers-status.yaml 文件：</p>
<p>     1.Pod 创建后还未被调度。</p>
<p>     2.Pod 已经被调度到 Node 上，但是容器还未被创建。</p>
<p>     3.等待创建第 1 个 init 容器。</p>
<p>     4.第 1 个 init 容器正在运行。</p>
<p>     5.第 1 个 init 容器正常退出，等待创建第 1 个 sidecar 容器。</p>
<p>     6.第 1 个 sidecar 容器正在运行，等待创建第 2 个 sidecar 容器。</p>
<p>     7.第 2 个 sidecar 容器正在运行，等待创建 main-container-1 和 main-container-2 两个主容器。</p>
<p>     8.两个主容器都正在运行。</p>
<p>     注意 READY 字段显示的容器数量是 4（2个 sidecar 容器 + 2 个主容器），而不是 2。这是因为 sidecar 容器也被包含在内，而 init 容器并不会被计算在内，因为 init 容器执行完任务就退出了。</p>
<p>     下面这张图展示了上面描述的 Pod 状态变化过程：</p>
<p><img src="/pic/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/Pod%E7%8A%B6%E6%80%81%E5%8F%98%E5%8C%96%E8%BF%87%E7%A8%8B3.webp" alt="Pod状态变化过程3"></p>
<p>     测试完毕后，执行以下命令删除这个 Pod。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f 3-init-and-sidecar-and-main-containers.yaml --force</span><br></pre></td></tr></table></figure>
<h4 id="7-sidecar-容器的-restartpolicy"><strong>7、Sidecar 容器的 RestartPolicy</strong></h4>
<p>     我们前面提到过，sidecar 容器是通过在原有的 init 容器中设置 restartPolicy: Always 来实现的。这意味着如果 sidecar 容器异常退出，kubelet 会自动重启它，从而确保 sidecar 容器在 Pod 的整个生命周期内都能一直运行。 在以下示例中，我们定义了两个 sidecar 容器，并分别设置它们运行 20 秒和 30 秒后退出。通过这种方式，我们可以观察 sidecar 容器的重启行为。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">          sleep 10</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 completed tasks and exited&quot;</span></span><br><span class="line"><span class="string"></span>    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sidecar-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span> <span class="comment"># sidecar 容器完成任务后退出</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;sidecar container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          echo &quot;sidecar container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">          sleep 20</span></span><br><span class="line"><span class="string">          echo &quot;sidecar container 1 completed tasks and exited&quot;</span></span><br><span class="line"><span class="string"></span>      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sidecar-container-2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span>  <span class="comment"># sidecar 容器完成任务后退出</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;sidecar container 2 is starting...&quot;</span></span><br><span class="line"><span class="string">          echo &quot;sidecar container 2 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">          sleep 30</span></span><br><span class="line"><span class="string">          echo &quot;sidecar container 2 completed tasks and exited&quot;</span></span><br><span class="line"><span class="string"></span>      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;main container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;main container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container-2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span> ]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;main container 2 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;main container 2 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br></pre></td></tr></table></figure>
<p>     执行以下命令应用上面的 Pod 资源。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f 4-sidecar-containers-restart.yaml</span><br></pre></td></tr></table></figure>
<p>     通过日志我们可以看到 sidecar-container-1 和 sidecar-container-2 分别在 20 秒和 30 秒后退出，然后又被重新启动了。</p>
<p><img src="/pic/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/Pod%E6%97%A5%E5%BF%974.webp" alt="Pod日志4"></p>
<p>     如果我们提前在另一个窗口执行 kubectl get pod -w 命令，可以观察到 Pod 的状态变化。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp   0/4     Pending   0          0s</span><br><span class="line">myapp   0/4     Pending   0          0s</span><br><span class="line">myapp   0/4     Init:0/3   0          0s</span><br><span class="line">myapp   0/4     Init:0/3   0          1s</span><br><span class="line">myapp   0/4     Init:1/3   0          11s</span><br><span class="line">myapp   1/4     Init:2/3   0          12s</span><br><span class="line">myapp   2/4     PodInitializing   0          13s</span><br><span class="line">myapp   4/4     Running           0          14s</span><br><span class="line">myapp   3/4     Running           0          32s</span><br><span class="line">myapp   4/4     Running           1 (2s ago)   33s</span><br><span class="line">myapp   3/4     Running           1 (11s ago)   42s</span><br><span class="line">myapp   4/4     Running           2 (1s ago)    43s</span><br></pre></td></tr></table></figure>
<p>     每行状态的解释如下，完整的 Pod 资源内容请查看 logs/4-sidecar-containers-restart-status.yaml 文件：</p>
<p>     Pod 创建后还未被调度。</p>
<p>     Pod 已经被调度到 Node 上，但是容器还未被创建。</p>
<p>     等待创建第 1 个 init 容器。</p>
<p>     第 1 个 init 容器正在运行。</p>
<p>     第 1 个 init 容器正常退出，等待创建第 1 个 sidecar 容器。</p>
<p>     第 1 个 sidecar 容器正在运行，等待创建第 2 个 sidecar 容器。</p>
<p>     第 2 个 sidecar 容器正在运行，等待创建 main-container-1 和 main-container-2 两个主容器。</p>
<p>     两个主容器都正在运行。</p>
<p>     sidecar-container-1 退出，kubelet 根据 restartPolicy: Always 自动重启 sidecar-container-1。</p>
<p>     sidecar-container-1 重启成功，所有容器都在运行状态。</p>
<p>     sidecar-container-2 退出，kubelet 根据 restartPolicy: Always 自动重启 sidecar-container-2。</p>
<p>     sidecar-container-2 重启成功，所有容器都在运行状态。</p>
<p>     下面这张图展示了上面描述的 Pod 状态变化过程：</p>
<p><img src="/pic/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/Pod%E7%8A%B6%E6%80%81%E5%8F%98%E5%8C%96%E8%BF%87%E7%A8%8B4.webp" alt="Pod状态变化过程4"></p>
<p>     测试完毕后，执行以下命令删除这个 Pod。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f 4-sidecar-containers-restart.yaml --force</span><br></pre></td></tr></table></figure>
<h4 id="8-容器探针"><strong>8、容器探针</strong></h4>
<p>     在上面的实验中，我们知道了主容器要等到 sidecar 容器运行以后才会开始启动。那么 sidecar 容器的探针是否会影响到主容器的启动呢？也就是说，主容器是否需要等到 sidecar 容器 Ready 后才能启动呢？让我们通过以下实验来寻找答案。</p>
<p>     sidecar 容器允许我们像主容器一样设置探针（startupProbe, readinessProbe, livenessProbe）来检查容器的健康状态。在下面的例子中，我们为两个 sidecar 容器分别添加了 readiness 探针，每个探针都会在容器启动后等待 30 秒才会通过。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">          sleep 10</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 completed tasks and exited&quot;</span></span><br><span class="line"><span class="string"></span>    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sidecar-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;sidecar container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;sidecar container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">readinessProbe:</span> <span class="comment"># sidecar 容器的 readiness 探针等待 30 秒通过</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">              echo &quot;readiness probe of sidecar container 1 is starting...&quot; &gt;&gt; /proc/1/fd/1</span></span><br><span class="line"><span class="string">              sleep 30</span></span><br><span class="line"><span class="string">              echo &quot;readiness probe of sidecar container 1 passed successfully&quot; &gt;&gt; /proc/1/fd/1</span></span><br><span class="line"><span class="string"></span>        <span class="attr">timeoutSeconds:</span> <span class="number">999</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sidecar-container-2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;sidecar container 2 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;sidecar container 2 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">readinessProbe:</span> <span class="comment"># sidecar 容器的 readiness 探针等待 30 秒通过</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">              echo &quot;readiness probe of sidecar container 2 is starting...&quot; &gt;&gt; /proc/1/fd/1</span></span><br><span class="line"><span class="string">              sleep 30</span></span><br><span class="line"><span class="string">              echo &quot;readiness probe of sidecar container 2 passed successfully&quot; &gt;&gt; /proc/1/fd/1</span></span><br><span class="line"><span class="string"></span>        <span class="attr">timeoutSeconds:</span> <span class="number">999</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;main container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;main container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container-2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span> ]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;main container 2 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;main container 2 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br></pre></td></tr></table></figure>
<p>     通过观察容器日志可以发现，两个主容器在 sidecar 容器的 readiness 探针通过之前就已经启动并开始执行任务了。 这表明主容器的启动并不需要等待 sidecar 容器达到 Ready 状态，只要 sidecar 容器处于 Running 状态即可。</p>
<p><img src="/pic/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/Pod%E6%97%A5%E5%BF%975.webp" alt="Pod日志5"></p>
<p>     如果我们提前在另一个窗口执行 kubectl get pod -w 命令，可以观察到 Pod 的状态变化。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp   0/4     Pending   0          0s</span><br><span class="line">myapp   0/4     Pending   0          0s</span><br><span class="line">myapp   0/4     Init:0/3   0          0s</span><br><span class="line">myapp   0/4     Init:0/3   0          1s</span><br><span class="line">myapp   0/4     Init:1/3   0          11s</span><br><span class="line">myapp   0/4     Init:2/3   0          12s</span><br><span class="line">myapp   0/4     PodInitializing   0          13s</span><br><span class="line">myapp   2/4     Running           0          14s</span><br><span class="line">myapp   3/4     Running           0          42s</span><br><span class="line">myapp   4/4     Running           0          43s</span><br></pre></td></tr></table></figure>
<p>     每行状态的解释如下，完整的 Pod 资源内容请查看 logs/5-readiness-probe-status.yaml 文件：</p>
<p>     Pod 创建后还未被调度。</p>
<p>     Pod 已经被调度到 Node 上，但是容器还未创建。</p>
<p>     等待创建第 1 个 init 容器。</p>
<p>     第 1 个 init 容器正在运行。</p>
<p>     第 1 个 init 容器正常退出，等待创建第 1 个 sidecar 容器。</p>
<p>     第 1 个 sidecar 容器正在运行，等待创建第 2 个 sidecar 容器。注意，此时 sidecar-container-1 并未处于 ready 状态，因为就绪探针还在执行中，也就是说一旦容器处于 Running 状态，下一个容器就会开始启动。</p>
<p>     第 2 个 sidecar 容器正在运行但并未处于 Ready 状态，等待创建 main-container-1 和 main-container-2 两个主容器。</p>
<p>     两个主容器都正在运行，并且处于 Ready 状态。</p>
<p>     sidecar-container-1 通过就绪探针检查，进入 Ready 状态。</p>
<p>     sidecar-container-2 通过就绪探针检查，进入 Ready 状态。</p>
<p>     下面这张图展示了上面描述的 Pod 状态变化过程：</p>
<p><img src="/pic/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/Pod%E7%8A%B6%E6%80%81%E5%8F%98%E5%8C%96%E8%BF%87%E7%A8%8B5.webp" alt="Pod状态变化过程5"></p>
<p>测试完毕后，执行以下命令删除这个 Pod。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f 5-readiness-probe.yaml --force</span><br></pre></td></tr></table></figure>
<h4 id="9-容器的停止顺序"><strong>9、容器的停止顺序</strong></h4>
<p>     我们当前使用的 Kubernetes 版本是 1.28.0。让我们首先看看在这个版本中删除 Pod 时，sidecar 容器和主容器的停止顺序是怎样的。</p>
<p>     在下面的示例中，我们为主容器设置了 preStop hook。在容器停止之前，Kubelet 会先执行 preStop hook 中定义的命令，然后才会发送 SIGTERM 信号给容器。</p>
<p>     为了让容器接收到 SIGTERM 信号，我们在容器中使用了 trap 命令来捕获 SIGTERM 信号。另外，通常 hook 和 probe 的输出不会打印在 kubectl logs 中，为了方便我们通过日志来对容器的状态进行观察，这里使用了一种间接的方法：将输出重定向到 /proc/1/fd/1 文件中。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">          sleep 10</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 completed tasks and exited&quot;</span></span><br><span class="line"><span class="string"></span>    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sidecar-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span> ]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;sidecar container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          sh -c &quot;</span></span><br><span class="line"><span class="string">            trap &#x27;</span></span><br><span class="line"><span class="string">              echo \&quot;sidecar container 1 received SIGTERM\&quot;;</span></span><br><span class="line"><span class="string">              sleep 3;</span></span><br><span class="line"><span class="string">              echo \&quot;sidecar container 1 stopped\&quot;;</span></span><br><span class="line"><span class="string">              exit 0</span></span><br><span class="line"><span class="string">            &#x27; TERM;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">            <span class="string">while</span> <span class="literal">true</span><span class="string">;</span> <span class="string">do</span></span><br><span class="line">              <span class="string">echo</span> <span class="string">\&quot;sidecar</span> <span class="string">container</span> <span class="number">1</span> <span class="string">is</span> <span class="string">doing</span> <span class="string">some</span> <span class="string">tasks...\&quot;;</span></span><br><span class="line">              <span class="string">sleep</span> <span class="number">3</span><span class="string">;</span></span><br><span class="line">            <span class="string">done</span></span><br><span class="line">          <span class="string">&quot;</span></span><br><span class="line"><span class="string">      restartPolicy: Always</span></span><br><span class="line"><span class="string">    - name: sidecar-container-2</span></span><br><span class="line"><span class="string">      image: busybox:1.35</span></span><br><span class="line"><span class="string">      command: [ &quot;</span><span class="string">sh&quot;,</span> <span class="string">&quot;-c&quot;</span> <span class="string">]</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;sidecar container 2 is starting...&quot;</span></span><br><span class="line"><span class="string">          sh -c &quot;</span></span><br><span class="line"><span class="string">            trap &#x27;</span></span><br><span class="line"><span class="string">              echo \&quot;sidecar container 2 received SIGTERM\&quot;;</span></span><br><span class="line"><span class="string">              sleep 3;</span></span><br><span class="line"><span class="string">              echo \&quot;sidecar container 2 stopped\&quot;;</span></span><br><span class="line"><span class="string">              exit 0</span></span><br><span class="line"><span class="string">            &#x27; TERM;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">            <span class="string">while</span> <span class="literal">true</span><span class="string">;</span> <span class="string">do</span></span><br><span class="line">              <span class="string">echo</span> <span class="string">\&quot;sidecar</span> <span class="string">container</span> <span class="number">2</span> <span class="string">is</span> <span class="string">doing</span> <span class="string">some</span> <span class="string">tasks...\&quot;;</span></span><br><span class="line">              <span class="string">sleep</span> <span class="number">3</span><span class="string">;</span></span><br><span class="line">            <span class="string">done</span></span><br><span class="line">          <span class="string">&quot;</span></span><br><span class="line"><span class="string">      restartPolicy: Always</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">    - name: main-container-1</span></span><br><span class="line"><span class="string">      image: busybox:1.35</span></span><br><span class="line"><span class="string">      command: [&quot;</span><span class="string">sh&quot;,</span> <span class="string">&quot;-c&quot;</span><span class="string">]</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;main container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          exec sh -c &quot;</span></span><br><span class="line"><span class="string">            trap &#x27;</span></span><br><span class="line"><span class="string">              echo \&quot;main container 1 received SIGTERM\&quot;;</span></span><br><span class="line"><span class="string">              sleep 10;</span></span><br><span class="line"><span class="string">              echo \&quot;main container 1 stopped\&quot;;</span></span><br><span class="line"><span class="string">              exit 0</span></span><br><span class="line"><span class="string">            &#x27; TERM;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">            <span class="string">while</span> <span class="literal">true</span><span class="string">;</span> <span class="string">do</span></span><br><span class="line">              <span class="string">echo</span> <span class="string">\&quot;main</span> <span class="string">container</span> <span class="number">1</span> <span class="string">is</span> <span class="string">doing</span> <span class="string">some</span> <span class="string">tasks...\&quot;;</span></span><br><span class="line">              <span class="string">sleep</span> <span class="number">3</span><span class="string">;</span></span><br><span class="line">            <span class="string">done</span></span><br><span class="line">          <span class="string">&quot;</span></span><br><span class="line"><span class="string">      lifecycle:</span></span><br><span class="line"><span class="string">        preStop:</span></span><br><span class="line"><span class="string">          exec:</span></span><br><span class="line"><span class="string">            command: [&quot;</span><span class="string">sh&quot;,</span> <span class="string">&quot;-c&quot;</span><span class="string">,</span> <span class="string">&quot;echo &#x27;main container 1 preStop hook is running...&#x27; &gt;&gt; /proc/1/fd/1; sleep 5&quot;</span><span class="string">]</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container-2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;main container 2 is starting...&quot;</span></span><br><span class="line"><span class="string">          exec sh -c &quot;</span></span><br><span class="line"><span class="string">            trap &#x27;</span></span><br><span class="line"><span class="string">              echo \&quot;main container 2 received SIGTERM\&quot;;</span></span><br><span class="line"><span class="string">              sleep 10;</span></span><br><span class="line"><span class="string">              echo \&quot;main container 2 stopped\&quot;;</span></span><br><span class="line"><span class="string">              exit 0</span></span><br><span class="line"><span class="string">            &#x27; TERM;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">            <span class="string">while</span> <span class="literal">true</span><span class="string">;</span> <span class="string">do</span></span><br><span class="line">              <span class="string">echo</span> <span class="string">\&quot;main</span> <span class="string">container</span> <span class="number">2</span> <span class="string">is</span> <span class="string">doing</span> <span class="string">some</span> <span class="string">tasks...\&quot;;</span></span><br><span class="line">              <span class="string">sleep</span> <span class="number">3</span><span class="string">;</span></span><br><span class="line">            <span class="string">done</span></span><br><span class="line">          <span class="string">&quot;</span></span><br><span class="line"><span class="string">      lifecycle:</span></span><br><span class="line"><span class="string">        preStop:</span></span><br><span class="line"><span class="string">          exec:</span></span><br><span class="line"><span class="string">            command: [&quot;</span><span class="string">sh&quot;,</span> <span class="string">&quot;-c&quot;</span><span class="string">,</span> <span class="string">&quot;echo &#x27;main container 2 preStop hook is running...&#x27; &gt;&gt; /proc/1/fd/1; sleep 5&quot;</span><span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>     执行以下命令应用上面的 Pod 资源。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f 6-prestop-hook.yaml</span><br></pre></td></tr></table></figure>
<p>     通过查看日志，可以看到主容器首先执行了 preStop hook，然后接收到了 SIGTERM 信号，最后优雅地退出了。同时，sidecar 容器也接收到了 SIGTERM 信号，但是它在主容器停止之前就已经停止了。</p>
<p><img src="/pic/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/Pod%E6%97%A5%E5%BF%976.webp" alt="Pod日志6"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp   0/4     Pending   0          0s</span><br><span class="line">myapp   0/4     Pending   0          0s</span><br><span class="line">myapp   0/4     Init:0/3   0          0s</span><br><span class="line">myapp   0/4     Init:0/3   0          1s</span><br><span class="line">myapp   0/4     Init:1/3   0          11s</span><br><span class="line">myapp   1/4     Init:2/3   0          12s</span><br><span class="line">myapp   2/4     PodInitializing   0          13s</span><br><span class="line">myapp   4/4     Running           0          14s</span><br><span class="line">myapp   4/4     Terminating       0          38s</span><br><span class="line">myapp   0/4     Terminating       0          53s</span><br><span class="line">myapp   0/4     Terminating       0          54s</span><br><span class="line">myapp   0/4     Terminating       0          54s</span><br><span class="line">myapp   0/4     Terminating       0          54s</span><br></pre></td></tr></table></figure>
<p>     每行状态的解释如下，完整的 Pod 资源内容请查看 logs/6-prestop-hook-status.yaml 文件：</p>
<p>     Pod 创建后还未被调度。</p>
<p>     Pod 已经被调度到 Node 上，但是容器还未创建。</p>
<p>     等待创建第 1 个 init 容器。</p>
<p>     第 1 个 init 容器正在运行。</p>
<p>     第 1 个 init 容器正常退出，等待创建第 1 个 sidecar 容器。</p>
<p>     第 1 个 sidecar 容器正在运行，等待创建第 2 个 sidecar 容器。</p>
<p>     第 2 个 sidecar 容器正在运行，等待创建 main-container-1 和 main-container-2 两个主容器。</p>
<p>     两个主容器都正在运行。</p>
<p>     接收到 Pod 删除的请求，开始停止容器。</p>
<p>     sidecar 容器和主容器都已经停止。</p>
<p>     在后面的几行 Terminating 中， 容器的状态并不会发生变化。</p>
<p>     以下这张图展示了上面描述的 Pod 状态变化过程：</p>
<p><img src="/pic/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/Pod%E7%8A%B6%E6%80%81%E5%8F%98%E5%8C%96%E8%BF%87%E7%A8%8B6.webp" alt="Pod状态变化过程6"></p>
<p>     然而，由于 sidecar 容器可能会在主容器之前停止，这种情况仍然可能带来一些问题。例如，如果 sidecar 容器负责收集日志，那么可能会造成部分日志内容缺失。又比如，如果 sidecar 容器提供网络代理功能，那么它的提前退出可能会导致主容器的网络连接中断。</p>
<p>     为了解决这个问题，从 Kubernetes 1.29 版本开始，如果 Pod 中包含一个或多个 sidecar 容器，kubelet 将延迟向这些 sidecar 容器发送 SIGTERM 信号，直到最后一个主容器完全终止。sidecar 容器将按照它们在 Pod spec 中定义的相反顺序终止。这确保了 sidecar 容器继续为 Pod 中的其他容器提供服务，直到不再需要它们。</p>
<p>     下面让我们创建一个 Kubernetes 1.29 版本的集群，然后再次测试 sidecar 容器的停止顺序。由于在 1.29 版本中 SidecarContainers 这个特性已经成为 Beta 版本，因此默认是开启的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kind create cluster --name=sidecar-demo-cluster-2 \</span><br><span class="line">--image kindest/node:v1.29.0</span><br></pre></td></tr></table></figure>
<p>     通过分析以下日志，我们可以清晰地看到容器退出的整个过程。首先两个主容器的 preStop hook 被执行，然后主容器接收到 Kubelet 发送的 SIGTERM 信号并正常退出。等到主容器完全退出后，sidecar-container-1 才会接收到 SIGTERM 信号并正常退出。最后，sidecar-container-2 接收到 SIGTERM 信号并正常退出。</p>
<p><img src="/pic/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/Pod%E6%97%A5%E5%BF%977.webp" alt="Pod日志7"></p>
<p>     下面这张图描述了 1.29 版本的 sidecar 容器的停止顺序：</p>
<p><img src="/pic/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/Pod%E7%8A%B6%E6%80%81%E5%8F%98%E5%8C%96%E8%BF%87%E7%A8%8B7.webp" alt="Pod状态变化过程7"></p>
<p>     测试完毕后，执行以下命令删除这个 Pod。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f 6-prestop-hook.yaml --force</span><br></pre></td></tr></table></figure>
<h4 id="10-容器资源的-request-和-limit"><strong>10、容器资源的 Request 和 Limit</strong></h4>
<p>     在 Kubernetes 中，我们可以为容器设置资源请求（request）和资源限制（limit）。当你为 Pod 中的容器指定了资源 request（请求）时，kube-scheduler 就根据该信息决定将 Pod 调度到哪个节点上。 当你为容器指定了资源 limit（限制） 时，kubelet 就可以确保运行的容器不会使用超出所设限制的资源。</p>
<p>     在评估节点是否有足够的资源来运行 Pod 时，kube-scheduler 会根据不同情况来计算 Pod 中容器资源的最大请求量。在没有引入 sidecar 容器的情况下，计算方式比较简单：资源的最大请求量是单个 init 容器的最大请求量与所有主容器请求量总和之间的最大值。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Max ( Max(initContainers), Sum(Containers) )</span><br></pre></td></tr></table></figure>
<p>     有了 sidecar 容器之后，计算公式会变得复杂一些。可以简单地分为两种情况：</p>
<ul>
<li>1.所有 sidecar 容器都是在 init 容器之后启动的。对于这种情况，我们只需要把所有 sidecar 容器的资源请求量与主容器的资源请求量相加，然后与单个 init 容器的最大请求量进行比较即可。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Max ( Max(initContainers), Sum(Containers) + Sum(Sidecar Containers) )</span><br></pre></td></tr></table></figure>
<ul>
<li>2.有一个或者多个 sidecar 容器是在 init 容器之前启动的。在这种情况下，当计算 init 容器的最大请求量时，我们需要把在该 init 容器之前启动的 sidecar 容器也考虑在内。在这里，我们使用 InitContainerUse(i) 来表示当启动 i 个 init 容器时，所需的最大资源请求量（等于该 init 容器的请求量 + 在该 init 容器之前启动的 sidecar 容器的请求量总和）：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InitContainerUse(i) = Sum(sidecar containers with index &lt; i) + InitContainer(i)</span><br></pre></td></tr></table></figure>
<p>     最后将 InitContainerUse 与所有主容器以及在该 init 容器之后启动的 sidecar 容器的总和进行比较，取最大值。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Max ( Max( each InitContainerUse ) , Sum(Sidecar Containers) + Sum(Containers) )</span><br></pre></td></tr></table></figure>
<p>     接下来我们用两个例子来验证上面的结论，当前 Kubernetes 集群中只有一个节点，使用 kubectl describe node 命令可以看到该节点总共有 10 个 CPU 可供分配，当前 CPU request 已经使用了 9% 的 CPU 资源，也就是说还有 9 个 完整的 CPU 可供分配。</p>
<p><img src="/pic/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/%E8%8A%82%E7%82%B9CPU%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5.webp" alt="节点CPU使用情况"></p>
<p>     在下面的示例中，我们为 init 容器设置了 9 个 CPU 的 request，为 sidecar 容器和主容器也设置了总共 9 个 CPU 的 request，这样 Pod 刚刚好被允许调度到节点上。如果你尝试将 init 容器的 CPU request 设置为 10，或者将任一 sidecar 容器或主容器的 CPU request 增加 1，那么这个 Pod 都将无法被调度到节点上。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 7-resource-requests.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">          sleep 10</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 completed tasks and exited&quot;</span></span><br><span class="line"><span class="string"></span>      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;9&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sidecar-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;sidecar container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;sidecar container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sidecar-container-2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;sidecar container 2 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;sidecar container 2 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;main container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;main container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container-2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span> ]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;main container 2 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;main container 2 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br></pre></td></tr></table></figure>
<p>     在第二个例子中，我们调整了容器的定义顺序，将 sidecar-container-1 移动到了 init-container-1 之前。虽然 Pod 的 CPU 资源请求总量没有改变，但你会发现这次 Pod 无法被调度到节点上了。这是因为在计算单个 init 容器的最大资源请求量时，sidecar-container-1 的资源请求量也被计入了。原本 init-container-1 的资源请求量是 9，现在加上了 sidecar-container-1 的资源请求量 1，最大的资源请求量就变为了 10，超过了节点的可用资源。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 8-resource-requests-init-container-after-sidecar-container.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sidecar-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;sidecar container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;sidecar container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">          sleep 10</span></span><br><span class="line"><span class="string">          echo &quot;init container 1 completed tasks and exited&quot;</span></span><br><span class="line"><span class="string"></span>      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;9&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sidecar-container-2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;sidecar container 2 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;sidecar container 2 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container-1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;main container 1 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;main container 1 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container-2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.35</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span> ]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;main container 2 is starting...&quot;</span></span><br><span class="line"><span class="string">          while true; do</span></span><br><span class="line"><span class="string">            echo &quot;main container 2 is doing some tasks...&quot;</span></span><br><span class="line"><span class="string">            sleep 3</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id="11-在-istio-中使用-sidecar-容器"><strong>11、在 Istio 中使用 Sidecar 容器</strong></h4>
<p>     在没有原生 sidecar 容器的支持之前，Istio 采用了一种变通的方法来保证 sidecar 容器在主容器之前启动：通过为 Istio 的 sidecar 容器添加一个 postStart hook，该 hook 会阻塞其他容器的启动，直到 sidecar 代理完全运行为止。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  initContainers:</span><br><span class="line">    - name: istio-init</span><br><span class="line">      ...</span><br><span class="line">  containers:</span><br><span class="line">    - name: istio-proxy</span><br><span class="line">      ...</span><br><span class="line">      lifecycle:</span><br><span class="line">        postStart:</span><br><span class="line">          exec:</span><br><span class="line">            command:</span><br><span class="line">              - pilot-agent</span><br><span class="line">              - wait</span><br></pre></td></tr></table></figure>
<p>     在 Istio 中可以通过将 holdApplicationUntilProxyStarts 设置为 true 来启用这个功能。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1.7 版本特性 https://github.com/istio/istio/pull/24737</span></span><br><span class="line">istioctl install --set values.global.proxy.holdApplicationUntilProxyStarts=true</span><br></pre></td></tr></table></figure>
<p>     在 Kubernetes 1.28 发布 SidecarContainers 的功能之后，现在我们直接可以在 Istio 中使用原生的 sidecar 容器了，只需将 pilot 的ENABLE_NATIVE_SIDECARS 环境变量设置为 true 即可。完整的教程请参见 Kubernetes Native Sidecars in Istio。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TAG=1.19.0-beta.0</span><br><span class="line">curl -L https://github.com/istio/istio/releases/download/$TAG/istio-$TAG-linux-amd64.tar.gz | tar xz</span><br><span class="line">./istioctl install --set values.pilot.env.ENABLE_NATIVE_SIDECARS=true -y</span><br></pre></td></tr></table></figure>
<h4 id="12-总结"><strong>12、总结</strong></h4>
<p>     本文首先回顾了传统 sidecar 模式存在的问题，包括 Job 无法正常终止、日志和指标收集不完整以及服务网格流量异常等等。随后，我们介绍了 Kubernetes 1.28 版本中引入的原生 sidecar 容器功能，这一功能旨在解决传统 sidecar 模式的局限性。我们还深入探讨了 sidecar 容器的其他特性，包括 sidecar 容器的启动顺序、重启策略、容器探针、停止顺序等。最后，我们简要地介绍了如何在 Istio 中利用原生 sidecar 容器来提升服务网格的可靠性。</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/x9bcRjWUiWdtQokHlU0MrQ">原文地址</a></p>

                
                <!-- reward -->
                
                    <div id="reword-out">
                        <div id="reward-btn">
                            打赏
                        </div>
                    </div>
                
            </div>
        

        <!-- copyright -->
        
        <footer class="article-footer">
             
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
    <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
            
                <a class="weibo share-sns" href="javascript:;" data-type="weibo">
                    <i class="ri-weibo-fill"></i>
                </a>
                <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
                    <i class="ri-wechat-fill"></i>
                </a>
                <a class="qq share-sns" href="javascript:;" data-type="qq">
                    <i class="ri-qq-fill"></i>
                </a>
                <a class="douban share-sns" href="javascript:;" data-type="douban">
                    <i class="ri-douban-line"></i>
                </a>
                <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
                  <i class="icon icon-qzone"></i>
                </a> -->
            
            <a class="facebook share-sns" href="javascript:;" data-type="facebook">
                <i class="ri-facebook-circle-fill"></i>
            </a>
            <a class="twitter share-sns" href="javascript:;" data-type="twitter">
                <i class="ri-twitter-fill"></i>
            </a>
            <a class="google share-sns" href="javascript:;" data-type="google">
                <i class="ri-google-fill"></i>
            </a>
        </div>
    </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
        <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://3546514206.github.io/2024/07/18/Kubernetes%E4%B8%AD%E5%8E%9F%E7%94%9F%E7%9A%84Sidecar%E5%AE%B9%E5%99%A8/"
             alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>
            
            
    <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/" rel="tag">云计算</a></li></ul>

        </footer>
    </div>

     
    <nav class="article-nav">
        
            <a href="/2024/08/02/%E6%90%BA%E7%A8%8B%E9%9B%86%E5%9B%A2%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0%E6%B1%87%E6%80%BB/" class="article-nav-link">
                <strong class="article-nav-caption">上一篇</strong>
                <div class="article-nav-title">
                    
                        携程集团技术文章汇总
                    
                </div>
            </a>
        
        
            <a href="/2024/07/04/%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2%E5%8D%95%E6%9C%BAK8S%E7%8E%AF%E5%A2%83/" class="article-nav-link">
                <strong class="article-nav-caption">下一篇</strong>
                <div class="article-nav-title">一键部署单机K8S环境</div>
            </a>
        
    </nav>


    
    
     

    
     
    
</article>

</section>
        <footer class="footer">
    <div class="outer">
        <ul>
            <li>
                Copyrights &copy;
                2017
                -
                
                2025
                <i class="ri-heart-fill heart_icon"></i> 杨海波
            </li>
        </ul>
        <ul>
            <li>
                
            </li>
        </ul>
        <ul>
            <li>
                
                    
                    <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
                
            </li>
        </ul>
        <ul>
            
        </ul>
        <ul>
            
        </ul>
        <ul>
            <li>
                <!-- cnzz统计 -->
                
            </li>
        </ul>
    </div>
</footer>
    </main>
    <div class="float_btns">
        <div class="totop" id="totop">
    <i class="ri-arrow-up-line"></i>
</div>

    <div class="todark" id="todark">
        <i class="ri-moon-line"></i>
    </div>

    </div>
    <aside class="sidebar on">
        <button class="navbar-toggle"></button>
<nav class="navbar">
    
        <div class="logo">
            <a href="/"><img src="/images/SETSUNAYANG.JPG" alt=""></a>
        </div>
    
    <ul class="nav nav-main">
        
            <li class="nav-item">
                <a class="nav-item-link" href="/">主 页</a>
            </li>
        
            <li class="nav-item">
                <a class="nav-item-link" href="/archives">归 档</a>
            </li>
        
            <li class="nav-item">
                <a class="nav-item-link" href="/tags">标 签</a>
            </li>
        
            <li class="nav-item">
                <a class="nav-item-link" target="_blank" rel="noopener" href="https://github.com/3546514206">Github</a>
            </li>
        
            <li class="nav-item">
                <a class="nav-item-link" target="_blank" rel="noopener" href="https://gb.cpolar.cn/">Gitlab</a>
            </li>
        
            <li class="nav-item">
                <a class="nav-item-link" target="_blank" rel="noopener" href="https://tongyi.aliyun.com/">通义千问</a>
            </li>
        
            <li class="nav-item">
                <a class="nav-item-link" target="_blank" rel="noopener" href="https://yuanbao.tencent.com/">腾讯元宝</a>
            </li>
        
            <li class="nav-item">
                <a class="nav-item-link" target="_blank" rel="noopener" href="https://www.cpolar.com/">Cpolar</a>
            </li>
        
            <li class="nav-item">
                <a class="nav-item-link" target="_blank" rel="noopener" href="https://cr.cpolar.cn">隧 道</a>
            </li>
        
            <li class="nav-item">
                <a class="nav-item-link" target="_blank" rel="noopener" href="http://192.168.0.1/">Hotspot</a>
            </li>
        
            <li class="nav-item">
                <a class="nav-item-link" target="_blank" rel="noopener" href="http://192.168.31.1/cgi-bin/luci/web">MiRouter</a>
            </li>
        
            <li class="nav-item">
                <a class="nav-item-link" target="_blank" rel="noopener" href="https://javabetter.cn/">进阶之路</a>
            </li>
        
            <li class="nav-item">
                <a class="nav-item-link" target="_blank" rel="noopener" href="https://pdai.tech/">pdai.tech</a>
            </li>
        
            <li class="nav-item">
                <a class="nav-item-link" target="_blank" rel="noopener" href="https://www.mobibrw.com/">友链 一</a>
            </li>
        
            <li class="nav-item">
                <a class="nav-item-link" target="_blank" rel="noopener" href="https://www.wujunhao1024.com/">友链 二</a>
            </li>
        
    </ul>
</nav>
<nav class="navbar navbar-bottom">
    <ul class="nav">
        <li class="nav-item">
            
                <a class="nav-item-link nav-item-search" title="搜索">
                    <i class="ri-search-line"></i>
                </a>
            
            
        </li>
    </ul>
</nav>
<div class="search-form-wrap">
    <div class="local-search local-search-plugin">
    <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
    <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
    <span class="close"><i class="ri-close-line"></i></span>
    <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
    <div class="reward-box">
        
            <div class="reward-item">
                <img class="reward-img" src="/images/alipay.jpg">
                <span class="reward-type">支付宝</span>
            </div>
        
        
            <div class="reward-item">
                <img class="reward-img" src="/images/wechat.jpg">
                <span class="reward-type">微信</span>
            </div>
        
    </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
    tocbot.init({
        tocSelector: ".tocbot",
        contentSelector: ".article-entry",
        headingSelector: "h1, h2, h3, h4, h5, h6",
        hasInnerContainers: true,
        scrollSmooth: true,
        scrollContainer: "main",
        positionFixedSelector: ".tocbot",
        positionFixedClass: "is-position-fixed",
        fixedSidebarOffset: "auto",
    });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
        rel="stylesheet"
        href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }

    viewer_init()
</script> 
<!-- MathJax -->
 <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });

    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script src="https://cdn.staticfile.org/mathjax/2.7.7/MathJax.js"></script>
<script src="https://cdn.staticfile.org/mathjax/2.7.7/config/TeX-AMS-MML_HTMLorMML-full.js"></script>
<script>
    var ayerConfig = {
        mathjax: true,
    };
</script>

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
    function wait(callback, seconds) {
        var timelag = null;
        timelag = window.setTimeout(callback, seconds);
    }

    !function (e, t, a) {
        var initCopyCode = function () {
            var copyHtml = '';
            copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
            copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
            copyHtml += '</button>';
            $(".highlight .code pre").before(copyHtml);
            $(".article pre code").before(copyHtml);
            var clipboard = new ClipboardJS('.btn-copy', {
                target: function (trigger) {
                    return trigger.nextElementSibling;
                }
            });
            clipboard.on('success', function (e) {
                let $btn = $(e.trigger);
                $btn.addClass('copied');
                let $icon = $($btn.find('i'));
                $icon.removeClass('ri-file-copy-2-line');
                $icon.addClass('ri-checkbox-circle-line');
                let $span = $($btn.find('span'));
                $span[0].innerText = 'COPIED';

                wait(function () { // 等待两秒钟后恢复
                    $icon.removeClass('ri-checkbox-circle-line');
                    $icon.addClass('ri-file-copy-2-line');
                    $span[0].innerText = 'COPY';
                }, 2000);
            });
            clipboard.on('error', function (e) {
                e.clearSelection();
                let $btn = $(e.trigger);
                $btn.addClass('copy-failed');
                let $icon = $($btn.find('i'));
                $icon.removeClass('ri-file-copy-2-line');
                $icon.addClass('ri-time-line');
                let $span = $($btn.find('span'));
                $span[0].innerText = 'COPY FAILED';

                wait(function () { // 等待两秒钟后恢复
                    $icon.removeClass('ri-time-line');
                    $icon.addClass('ri-file-copy-2-line');
                    $span[0].innerText = 'COPY';
                }, 2000);
            });
        }
        initCopyCode();
    }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
    if (window.mermaid) {
        mermaid.initialize({theme: "forest"});
    }
</script>


    
    

</div>
</body>

</html>